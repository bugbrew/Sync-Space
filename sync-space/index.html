<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>SyncSpace - Live Collaboration</title>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            margin: 0;
            background: #2c3e50;
            color: white;
            overflow: hidden;
        }

        #toolbar {
            background: #1a1a1a;
            padding: 15px;
            display: flex;
            gap: 15px;
            justify-content: center;
            align-items: center;
            border-bottom: 2px solid #34495e;
        }

        canvas {
            background: white;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            cursor: crosshair;
            display: block;
            margin: 20px auto;
        }

        .cursor-label {
            position: absolute;
            pointer-events: none;
            padding: 2px 8px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            border-radius: 4px;
            font-size: 12px;
            z-index: 100;
            white-space: nowrap;
        }

        button {
            padding: 8px 15px;
            cursor: pointer;
            background: #3498db;
            border: none;
            color: white;
            border-radius: 4px;
            font-weight: bold;
        }

        button:hover {
            background: #2980b9;
        }

        .btn-clear {
            background: #e74c3c;
        }

        .btn-clear:hover {
            background: #c0392b;
        }
    </style>
</head>

<body>

    <div id="toolbar">
        <strong>SyncSpace</strong>
        <input type="color" id="colorPicker" value="#000000">
        <select id="sizePicker">
            <option value="2">Thin</option>
            <option value="5" selected>Medium</option>
            <option value="15">Thick</option>
        </select>
        <button onclick="tool='brush'">Brush</button>
        <button onclick="tool='eraser'">Eraser</button>
        <button class="btn-clear" id="clearBtn">Clear Board</button>
        <div id="status">Connecting...</div>
    </div>

    <div id="canvas-container" style="position: relative;">
        <canvas id="canvas" width="1100" height="650"></canvas>
        <div id="cursors-container"></div>
    </div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        const socket = io("http://localhost:5001"); // Update this to your Render URL later
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const name = prompt("Enter your name:") || "Guest";

        let drawing = false;
        let tool = 'brush';
        let lastPos = { x: 0, y: 0 };

        socket.on('connect', () => document.getElementById('status').innerText = `User: ${name}`);

        function draw(x, y, lx, ly, color, size) {
            ctx.strokeStyle = color;
            ctx.lineWidth = size;
            ctx.lineCap = 'round';
            ctx.beginPath();
            ctx.moveTo(lx, ly);
            ctx.lineTo(x, y);
            ctx.stroke();
        }

        canvas.onmousedown = (e) => {
            drawing = true;
            lastPos = { x: e.offsetX, y: e.offsetY };
        };

        canvas.onmousemove = (e) => {
            socket.emit('cursor-move', { x: e.offsetX, y: e.offsetY, name });
            if (!drawing) return;

            const color = tool === 'eraser' ? '#FFFFFF' : document.getElementById('colorPicker').value;
            const size = document.getElementById('sizePicker').value;

            draw(e.offsetX, e.offsetY, lastPos.x, lastPos.y, color, size);
            socket.emit('draw-data', { x: e.offsetX, y: e.offsetY, lastX: lastPos.x, lastY: lastPos.y, color, size });
            lastPos = { x: e.offsetX, y: e.offsetY };
        };

        canvas.onmouseup = () => {
            drawing = false;
            socket.emit('save-to-memory', canvas.toDataURL());
        };

        // --- GLOBAL SYNC ---
        socket.on('draw-data', (data) => draw(data.x, data.y, data.lastX, data.lastY, data.color, data.size));

        socket.on('load-canvas', (url) => {
            const img = new Image();
            img.onload = () => ctx.drawImage(img, 0, 0);
            img.src = url;
        });

        document.getElementById('clearBtn').onclick = () => socket.emit('clear-canvas-request');
        socket.on('clear-canvas-execute', () => ctx.clearRect(0, 0, canvas.width, canvas.height));

        socket.on('cursor-update', (data) => {
            let el = document.getElementById(`cursor-${data.id}`);
            if (!el) {
                el = document.createElement('div');
                el.id = `cursor-${data.id}`;
                el.className = 'cursor-label';
                document.getElementById('cursors-container').appendChild(el);
            }
            el.style.left = (canvas.offsetLeft + data.x) + "px";
            el.style.top = (canvas.offsetTop + data.y) + "px";
            el.innerText = data.name;
        });

        socket.on('user-left', (id) => {
            const el = document.getElementById(`cursor-${id}`);
            if (el) el.remove();
        });
    </script>
</body>

</html>